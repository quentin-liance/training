# ========================================
# Continuous Integration Workflow
# ========================================
# This workflow runs automated tests and quality checks
# on every push and pull request to main/develop branches

name: CI

# Trigger conditions for the workflow
on:
  push:
    branches: [master, main, develop]  # Run on pushes to these branches
  pull_request:
    branches: [master, main, develop]  # Run on pull requests to these branches

jobs:
  test:
    runs-on: ubuntu-latest  # Use latest Ubuntu runner

    # Test matrix: run tests on multiple Python versions
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      # Step 1: Check out the repository code
      - uses: actions/checkout@v4

      # Step 2: Set up the specified Python version
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # Step 3: Install UV package manager (faster than pip)
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      # Step 4: Create virtual environment and install dependencies
      - name: Create virtual environment and install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .[dev]
          # Verify mypy installation
          which mypy || uv pip install mypy>=1.8.0
          # Install additional type stubs for mypy
          uv pip install pandas-stubs types-requests

      # Step 5: Run code linting and formatting checks with Ruff
      - name: Run linting
        run: |
          source .venv/bin/activate
          ruff check .           # Check for code quality issues
          ruff format --check .  # Verify code formatting

      # Step 6: Run static type checking with mypy
      - name: Run type checking
        run: |
          source .venv/bin/activate
          mypy src/

      # Step 7: Run the test suite with coverage measurement
      - name: Run tests
        run: |
          source .venv/bin/activate
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term

      # Step 8: Upload coverage report to Codecov (optional)
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml  # Coverage report file
          fail_ci_if_error: false  # Don't fail CI if upload fails
